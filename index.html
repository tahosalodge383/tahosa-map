<!doctype html>
<!--Author: Brendan Curley (bcurley.scouting@gmail.com)-->
<!--Date: 2/14/2025-->
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="yes" name="mobile-web-app-capable">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <link crossorigin="" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          rel="stylesheet"/>
    <link href="css/qgis2web.css" rel="stylesheet">
    <link href="css/fontawesome-all.min.css" rel="stylesheet">
    <link href="css/leaflet-control-geocoder.Geocoder.css" rel="stylesheet">
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
    </style>
    <title>Tahosa Lodge Chapters Map</title>
</head>
<body>
<div id="map">
</div>
<script src="js/qgis2web_expressions.js"></script>
<script crossorigin=""
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="js/leaflet.rotatedMarker.js"></script>
<script src="js/leaflet.pattern.js"></script>
<script src="js/leaflet-hash.js"></script>
<script src="js/Autolinker.min.js"></script>
<script src="js/rbush.min.js"></script>
<script src="js/labelgun.min.js"></script>
<script src="js/labels.js"></script>
<script src="js/leaflet-control-geocoder.Geocoder.js"></script>
<script src="data/GreaterColoradoCouncil_1.js"></script>
<script>
    let map; // Global variable required by labels.js

    /**
     * Application Configuration
     */
    const CONFIG = {
        PANE: {
            OSM: 'pane_OSMStandard_0',
            GCC: 'pane_GreaterColoradoCouncil_1'
        },
        Z_INDEX: {
            OSM: 400,
            GCC: 401
        },
        MAP_BOUNDS: [
            [37.3308234523154, -110.50103985219809],
            [41.09061353391376, -102.26556933969704]
        ],
        TILE: {
            URL: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
            ATTRIBUTION: 'Map data Â© <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a>'
        },
        BASE_POLY_STYLE: {
            opacity: 1,
            color: 'rgba(35,35,35,1.0)',
            dashArray: '',
            lineCap: 'butt',
            lineJoin: 'miter',
            weight: 1.0,
            fill: true,
            fillOpacity: 0.5,
            interactive: true
        }
    };

    /**
     * Map Utilities and Event Handlers
     */
    const MapUtils = {
        highlightLayer: null,

        isLineGeometry: (feature) =>
            feature?.geometry?.type === 'LineString' || feature?.geometry?.type === 'MultiLineString',

        highlightFeature: (e) => {
            const target = e.target;
            MapUtils.highlightLayer = target;
            if (typeof target?.setStyle === 'function') {
                if (MapUtils.isLineGeometry(target.feature)) {
                    target.setStyle({color: '#ffff00'});
                } else {
                    target.setStyle({fillColor: '#ffff00', fillOpacity: 0.5});
                }
            }
            if (typeof target?.openPopup === 'function') {
                target.openPopup();
            }
        },

        resetFeature: (e, layer) => {
            const target = e.target;
            if (layer && typeof layer.resetStyle === 'function' && target) {
                layer.resetStyle(target);
            } else if (target && target._eventParents) {
                Object.values(target._eventParents).forEach(parent => {
                    if (typeof parent.resetStyle === 'function') {
                        parent.resetStyle(target);
                    }
                });
            }

            if (layer && typeof layer.closePopup === 'function') {
                layer.closePopup();
            } else if (layer && typeof layer.eachLayer === 'function') {
                layer.eachLayer((inner) => {
                    if (typeof inner.closePopup === 'function') inner.closePopup();
                });
            } else if (typeof target?.closePopup === 'function') {
                target.closePopup();
            }
        },

        ensurePanes: (mapInstance) => {
            if (!mapInstance) return;
            const ensurePane = (name, z) => {
                if (!mapInstance.getPane(name)) mapInstance.createPane(name);
                const paneEl = mapInstance.getPane(name);
                if (paneEl && paneEl.style.zIndex !== String(z)) {
                    paneEl.style.zIndex = String(z);
                }
            };
            ensurePane(CONFIG.PANE.OSM, CONFIG.Z_INDEX.OSM);
            ensurePane(CONFIG.PANE.GCC, CONFIG.Z_INDEX.GCC);

            const gccPane = mapInstance.getPane(CONFIG.PANE.GCC);
            if (gccPane) gccPane.style['mix-blend-mode'] = 'normal';
        },

        filterEmptyPopupRows: (content, feature) => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const rows = tempDiv.querySelectorAll('tr');
            rows.forEach(row => {
                const td = row.querySelector('td.visible-with-data');
                const key = td?.id;
                const val = key ? feature?.properties?.[key] : undefined;
                if (td && (val === null || val === undefined || val === '')) {
                    row.remove();
                }
            });
            return tempDiv.innerHTML;
        },

        setPopupMediaClass: (content, popup) => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            if (tempDiv.querySelector('td img')) {
                popup._contentNode.classList.add('media');
                setTimeout(() => popup.update(), 10);
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
    };

    /**
     * GCC Layer Logic
     */
    const GCCLayerStrategy = {
        getPopupHtml: (feature, autolinker) => {
            const safe = (v) =>
                v !== null && v !== undefined
                    ? autolinker.link(String(v).replace(/'/g, "'").replace(/"/g, '&quot;').toLocaleString())
                    : '';

            const chapter = safe(feature.properties['Chapter']);
            const district = safe(feature.properties['District']);

            const html = `
              <table>
                <tr><td colspan="2"><strong>Chapter</strong><br />${chapter}</td></tr>
                <tr><td colspan="2"><strong>District</strong><br />${district}</td></tr>
              </table>`;
            return MapUtils.filterEmptyPopupRows(html, feature);
        },

        style: (feature) => {
            const fillColor = feature?.properties?.fillColor || '#cccccc';
            return {
                ...CONFIG.BASE_POLY_STYLE,
                pane: CONFIG.PANE.GCC,
                fillColor
            };
        },

        onEachFeature: (feature, layer, autolinker) => {
            layer.on({
                mouseout: (e) => MapUtils.resetFeature(e, layer),
                mouseover: MapUtils.highlightFeature,
                click: () => {
                    const url = feature.properties['URL'];
                    if (url) window.open(url, '_top');
                }
            });
            const popupContent = GCCLayerStrategy.getPopupHtml(feature, autolinker);
            layer.on('popupopen', (e) => MapUtils.setPopupMediaClass(popupContent, e.popup));
            layer.bindPopup(popupContent, {maxHeight: 400, autoPan: false});
        }
    };

    /**
     * Setup Functions
     */
    function setupBaseLayer(mapInstance) {
        const osmLayer = L.tileLayer(CONFIG.TILE.URL, {
            pane: CONFIG.PANE.OSM,
            opacity: 1.0,
            attribution: CONFIG.TILE.ATTRIBUTION,
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        mapInstance.addLayer(osmLayer);
    }

    function setupGCCLayer(mapInstance, autolinker) {
        const layer = new L.geoJson(json_GreaterColoradoCouncil_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_GreaterColoradoCouncil_1',
            layerName: 'layer_GreaterColoradoCouncil_1',
            pane: CONFIG.PANE.GCC,
            onEachFeature: (f, l) => GCCLayerStrategy.onEachFeature(f, l, autolinker),
            style: GCCLayerStrategy.style
        });
        mapInstance.addLayer(layer);
        return layer;
    }

    function setupControls(mapInstance) {
        L.control.zoom({position: 'topleft'}).addTo(mapInstance);

        new L.Control.Geocoder({
            collapsed: true,
            position: 'topleft',
            placeholder: 'Search...'
        }).addTo(mapInstance);

        const geocoderIcon = document.querySelector('.leaflet-control-geocoder-icon');
        if (geocoderIcon) {
            geocoderIcon.classList.add('fas', 'fa-search');
            geocoderIcon.setAttribute('title', 'Search for a place');
        }
    }

    function bindLabelsToLayer(layer) {
        layer.eachLayer((l) => {
            const chapter = l.feature.properties['Chapter'];
            const html = chapter !== null
                ? `<div style="color: #323232; font-size: 12pt; font-weight: bold; font-family: 'Open Sans', sans-serif;">${chapter}</div>`
                : '';
            l.bindTooltip(html, {
                permanent: true,
                direction: 'center',
                offset: [0, 16],
                className: 'css_GreaterColoradoCouncil_1'
            });

            // Uses global variables from js/labels.js
            labels.push(l);
            totalMarkers += 1;
            l.added = true;
        });

        const reset = () => resetLabels([layer]);
        reset(); // Initial call to initialize labels
        map.on('zoomend', reset);
        map.on('layeradd', reset);
        map.on('layerremove', reset);
    }

    /**
     * Main Initialization
     */
    function initApp() {
        map = L.map('map', {zoomControl: false, maxZoom: 28, minZoom: 1})
            .fitBounds(CONFIG.MAP_BOUNDS);

        MapUtils.ensurePanes(map);
        new L.Hash(map);

        map.attributionControl.setPrefix(
            '<a href="https://github.com/tahosalodge383/tahosa-map" target="_blank">GitHub</a> &middot; ' +
            '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
            '<a href="https://leafletjs.com" target="_blank">Leaflet</a> &middot; ' +
            '<a href="https://qgis.org" target="_blank">QGIS</a>'
        );

        const autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        setupBaseLayer(map);
        const gccLayer = setupGCCLayer(map, autolinker);

        setupControls(map);
        bindLabelsToLayer(gccLayer);
    }

    // Start Application
    initApp();
</script>
</body>
</html>
